<!-- $Id$ -->
<html>
<head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<title>Code Generation</title>
<link href="default.css" rel="stylesheet" type="text/css">
</head>
<body>
<html>
<h1>Code Generation</h1>
This code generator is patterened after the Ptolemy Classic 
code generator where actors have template files consisting
of code blocks.  The code blocks are stitched together to create
the resulting file.

<h2>Simple Demo</h2>
<ol>
<li>
Open <a href="demo/Ramp/Ramp.xml"><code>$PTII/ptolemy/codegen/Demo/Ramp/Ramp.xml</code></a>
<li> Click on the StaticSchedulingCodeGeneratorIcon.
<li> A dialog box will appear, click on "Generate"
<li> The code will be generated, conpiled, run and the results displayed.
</ol>

<h2>How it works</h2>
This code generator uses reflection to find helper classes that in
turn refer to code blocks.  
<p>For example, if a model contains <code>ptolemy.actor.lib.Ramp</code>,
we look for in <code>$PTII/ptolemy/codegen/c/actor/lib/</code>
for <code>Ramp.java</code> and <code>Ramp.c</code>.

<p><code>Ramp.java</code> contains a method:
<pre>
public void generateFireCode(StringBuffer stream)
                throws IllegalActionException 
        ptolemy.actor.lib.Ramp actor = (ptolemy.actor.lib.Ramp) getComponent();

        String type = codeGenType(TypeLattice.leastUpperBound(actor.init
                .getType(), actor.step.getType()));
        if (!isPrimitiveType(type)) {
            type = "Token";
        }

        _codeStream.appendCodeBlock(type + "FireBlock");
        return processCode(_codeStream.toString());
}
</pre>
The method first gets the type and then appends a <i>codeBlock<i>
called <code>type + "FireBlock"</code>.  For example, if
the type is Int, then we append the codeBlock 
<code>IntFireBlock</code>, which can be found in
 <code>Ramp.c</code>:
<pre>
/***IntFireBlock***/
        $ref(output) = $actorSymbol(state);
        $actorSymbol(state) += $val(step);
/**/
</pre>
(There are other codeBlocks for other types. )

When the code generator runs, it runs <code>generateFireCode()</code>
which reads in <code>IntFireBlock</code> and writes it to the output file,
<code>~/codegen/Ramp.c, which will contain
<pre>
        _Ramp_Ramp_output_0 = _Ramp_Ramp_state;
        _Ramp_Ramp_state += 2;
</pre>

The <code>$ref</code> and <code>$val</code> in <code>IntFireBlock</code>
are macros, which represent ports, states (including parameters) of
the actor. For example, <code>$ref(output)</code> represents the
<code>output</code> port of the <code>Ramp</code> actor in this
model. When the code generator process a macro in the code string, it
replaces the macro with a unique variable or a concrete value
pertinent to the actor.

<p>
Currently, we have the following macros:
<p> <code>$ref(name)</code>

<br>Returns a reference of a state or a port. If the argument,
<code>name</code>, refers to a port, it by default refers to the first
token in the buffer of that port. If the port is a multiport, say
<code>input</code>, we use <code>$ref(input#0)</code> to refer to the
first channel of the <code>input</code> port.

<p> <code>$ref(name, offset)</code>

<br> Returns a reference to an array state or a port with an offset
that is not negative.  For a port, it refers to the
<code>offset</code>-th token in the buffer of that port. For an array
state, it refers to the <code>offset</code>-th element in the array.

<p><code>$val(name)</code>
<br>Returns the current value of a state.
<p><code>$size(name)</code>

<br>Returns the size of a state. The size of a non-array state is one;
the size of an array state is the length of the array.
<p>
<code>$actorSymbol(name)</code>
<br>
Returns a unique variable for the actor.
<p>

<h2>Invoking the code generator by hand</h2>
Use the command below to invoke the code generator by hand:
<pre>
$PTII/bin/ptinvoke ptolemy.codegen.kernel.CodeGenerator $PTII/ptolemy/codegen/c/actor/lib/test/auto/Ramp.xml
</pre>
Or, you can run <code>$PTII/bin/ptcg</code>, which invokes the CodeGenerator
class for you:
<pre>
$PTII/bin/ptcg $PTII/ptolemy/codegen/c/actor/lib/test/auto/Ramp.xml
</pre>

<h2>Macro description</h2>
<i>FIXME</i>

<h2>Helper writer style guide</h2>
<i>FIXME: Include details about running template generator</i>

<menu>
<li> Be sure to add and @see tag to the base actor

<li> When writing helpers, try to put as much as possible into
the .c file.  The reason is that if we have keep the language
specific code in the .c files, then in the future it will be easier
to support other languages.


<li> To add a comment to output from within a Java file, use
<CODE>CodeGenerator.comment()</CODE> so that the comment is
properly indented and has the appropriate language specific
comment tag.  For example,
<pre>
       code.append(_codeGenerator.comment(1, "My Comment.");
</pre>
will append a comment with one level of indent
<pre>
    /* My Comment. */
</pre>
to the output.
<br>Currently, only C-style comments are supported
<CODE>/* <I>comment</I> */</CODE>, but support for other 
languages will be easier if we avoid C specific code.

<li> Code should be properly indented.  Usually, actor
helper code written in .c files is indented 8 spaces so that
it is properly indented in the output file (four spaces
for the <CODE>main()</CODE> body, four spaces for the
<CODE>while()</CODE> or <CODE>for()</CODE> loop that
iterates through the actors.

</menu>


<h2>Status of individual classes</h2>


 <p>For each class, the number represent the number of demos that use that class.
     <br>The text underneath is the names of the demos that use that class.
     <br>And then the proposed and accepted ratings
     <br>And then comments  about the state of that class

<pre>
ptolemy.codegen.kernel.StaticSchedulingCodeGenerator
    AdaptiveCoding
    Blending
    Butterfly
    Case
    Fibonacci
    Hysteresis
    Merge
    ModalBSC
     *  @Pt.ProposedRating Yellow (eal)
     *  @Pt.AcceptedRating Red (cxh) Needs class documentation
 *  FIXME: need documentation on the following:
 *  1. Define static-scheduling,
 *  2. what should the subclasses do.
 *  3. Define body code, wrapup, initialize section.

ptolemy.codegen.kernel.ParseTreeCodeGenerator
    AdaptiveCoding
    Blending
    Butterfly
    Case
    Fibonacci
    Hysteresis
    Merge
    ModalBSC
     @Pt.ProposedRating Red
     @Pt.AcceptedRating Red


ptolemy.codegen.c.kernel.CParseTreeCodeGenerator
    AdaptiveCoding
    Blending
    Butterfly
    Case
    Fibonacci
    Hysteresis
    Merge
    ModalBSC
     @Pt.ProposedRating Red
     @Pt.AcceptedRating Red
 Has these limitations, will not be Yellow for release.
 * It is a copy of ParseTreeCodeGenerator from data/expr and thus
   has lots of code for evaluating expressions, which we don't need
 * It is not properly converting types: We need to add logic to
   convert types.
 * The .tcl test has known failures involving nulls
 * It does not evaluate constants.



ptolemy.codegen.c.CodeGeneratorHelper
    fire etc. methods need to mention what blocks are read in

ptolemy.codegen.c.kernel.CCodeGeneratorHelper
    AdaptiveCoding
    Blending
    Butterfly
    Case
    Fibonacci
    Hysteresis
    Merge
    ModalBSC
    @Pt.ProposedRating Red (cxh) Remove mostly empty methods, add info about writing actors.
   @Pt.AcceptedRating Red (cxh)

ptolemy.codegen.gui.CodeGeneratorGUI
    AdaptiveCoding
    Blending
    Butterfly
    Case
    Fibonacci
    Hysteresis
    Merge
    ModalBSC
     @Pt.ProposedRating Red (eal) cxh: clean up code in prep for review.
     @Pt.AcceptedRating Red (eal)

ptolemy.codegen.c.actor.TypedCompositeActor
    AdaptiveCoding
    Blending
    Butterfly
    Case
    Fibonacci
    Hysteresis
    Merge
    ModalBSC
     @Pt.ProposedRating Yellow (cxh)
     @Pt.AcceptedRating Red (zgang)
     cxh: cleanup and prep for review

ptolemy.codegen.c.domains.sdf.kernel.SDFDirector
    AdaptiveCoding
    Blending
    Butterfly
    Case
    Hysteresis
    Merge
    ModalBSC
 @Pt.ProposedRating Yellow (cxh)
 @Pt.AcceptedRating Red (eal)
 Ready for review, though it has: 
 FIXME: Should associated with a static scheduling code generator.

ptolemy.codegen.kernel.CodeGeneratorUtilities
    AdaptiveCoding
    Blending
    Case
    Hysteresis
    Merge
    ModalBSC
     @Pt.ProposedRating Red (cxh)
     @Pt.AcceptedRating Red (cxh)
     cxh: cleanup and prep for review

ptolemy.codegen.c.domains.fsm.kernel.FSMActor
    AdaptiveCoding
    Blending
    Fibonacci
    Hysteresis
    Merge
    ModalBSC
     @Pt.ProposedRating Red (zgang)
     @Pt.AcceptedRating Red (zgang)


ptolemy.codegen.c.domains.fsm.kernel.FSMDirector
    AdaptiveCoding
    Blending
    Hysteresis
    Merge
    ModalBSC
     @Pt.ProposedRating Red (zgang)
     @Pt.AcceptedRating Red (zgang)
 Gang: we reviewed this on March 7, can you update the tag?

ptolemy.codegen.c.actor.lib.Ramp
    AdaptiveCoding
    Blending
    Butterfly
    Case
    Hysteresis
 @Pt.ProposedRating Red (cxh) String, Complex, Fix, Matrix and Array inputs are not supported
 @Pt.AcceptedRating Red (mankit) 
 Jackie: Add support for String and Array

ptolemy.codegen.c.domains.hdf.kernel.HDFFSMDirector
    AdaptiveCoding
    Merge
     @Pt.ProposedRating Yellow (cxh)
     @Pt.AcceptedRating Red (zgang)
 Ready for review

ptolemy.codegen.c.domains.hdf.kernel.HDFDirector
    AdaptiveCoding
    Merge
     @Pt.ProposedRating Yellow (cxh)
     @Pt.AcceptedRating Red (zgang)
 Ready for review

ptolemy.codegen.c.domains.fsm.kernel.MultirateFSMDirector
    AdaptiveCoding
    Merge
     @Pt.ProposedRating Red (zgang)
     @Pt.AcceptedRating Red (zgang)
 Gang: we reviewed this on March 7, can you update the tag?

ptolemy.codegen.c.actor.lib.gui.SequencePlotter
    Blending
    Case
    Hysteresis
    ModalBSC
     @Pt.ProposedRating Red (mankit) Need to handle plot configuration info
     @Pt.AcceptedRating Red (mankit)

ptolemy.codegen.c.actor.lib.Expression
    Blending
    Butterfly
     * @Pt.ProposedRating Red (mankit) Needs 2nd pass for array childreno f different types
     * @Pt.AcceptedRating Red (mankit)

ptolemy.codegen.c.actor.lib.conversions.BooleanToAnything
    AdaptiveCoding
    ModalBSC
     @Pt.ProposedRating Yellow (mankit) Works w/Array, but has problems if params are not of the same type
     @Pt.AcceptedRating Red (cxh)
 Need tests for Array before shipping.

ptolemy.codegen.c.actor.lib.AddSubtract
    Blending
    Hysteresis
     @Pt.ProposedRating Red (mankit) TODO: need $ref(something#i) to specify variables for different channels
     @Pt.AcceptedRating Red (eal)
 Complex, Fix, Matrix and Array inputs are not supported

ptolemy.codegen.c.domains.fsm.modal.TransitionRefinement
    ModalBSC
     @Pt.ProposedRating Green (cxh)
     @Pt.AcceptedRating Green (cxh)
DONEDONEDONEDONEDONE

ptolemy.codegen.c.actor.lib.hoc.Refinement
    Case
     @Pt.ProposedRating Red (zgang)
     @Pt.AcceptedRating Red (zgang)

ptolemy.codegen.c.actor.lib.hoc.MultiCompositeActor
    Case
     @Pt.ProposedRating Red (zgang)
     @Pt.AcceptedRating Red (zgang)

ptolemy.codegen.c.actor.lib.hoc.CaseDirector
    Case
     @Pt.ProposedRating Red (zgang)
     @Pt.AcceptedRating Red (zgang)

ptolemy.codegen.c.actor.lib.hoc.Case
    Case
     @Pt.ProposedRating Red (zgang)
     @Pt.AcceptedRating Red (zgang)

ptolemy.codegen.c.actor.lib.gui.XYPlotter
    Butterfly
     * @Pt.ProposedRating Red (mankit) Need to handle plot configuration info
     * @Pt.AcceptedRating Red (mankit)

ptolemy.codegen.c.actor.lib.Scale
    Blending
    Case
    ModalBSC
     @Pt.ProposedRating Red (mankit) TODO: handle ArrayToken as input
     @Pt.AcceptedRating Red (zgang)

ptolemy.codegen.c.actor.lib.MultiplyDivide
    AdaptiveCoding
     @Pt.ProposedRating Red (mankit)  TODO:  $ref(something#i) to specify variables for different channels would make the code cleaner
     @Pt.AcceptedRating Red (cxh)
 Complex, Fix, Matrix and Array inputs are not supported

ptolemy.codegen.c.actor.lib.Pulse
    Merge
     @Pt.ProposedRating Red (cxh) Complex, Fix, Matrix and Array inputs are not supported: Needs tests for these
     @Pt.AcceptedRating Red (zgang)
DONEDONEDONEDONEDONEDONEDONE

ptolemy.codegen.c.actor.lib.MonitorValue
    AdaptiveCoding
     *  @Pt.ProposedRating Red (cxh) Complex, Fix, Matrix and Array inputs are not supported
     *  @Pt.AcceptedRating Red (zgang)
 Needs to work with Array to be shipped 
DONEDONEDONEDONEDONEDONEDONE

ptolemy.codegen.c.actor.lib.Accumulator
    AdaptiveCoding
     * @Pt.ProposedRating Red (mankit) TODO: Needs to work with String, ArrayToken.  Similar to Ramp
     * @Pt.AcceptedRating Red (zgang)

These are done:
   Stop
   ThrowException
</pre>



Edward wrote:
<BLOCKQUOTE>
the following should have highest priority, I think:
<ul>

<li> FileReader.java
<pre>
    Not used in demo.
    The use of FileReader below is because we are using a
    static method in FileReader.
    Done?
</pre>

<li> Comparator.java
     <br>No demo, have tests


<li> Equals.java
<pre>
  No demo, have test
 @Pt.ProposedRating Red (mankit) Works with Doubles and Strings, Needs to work with Arrays
</pre>


</ul>

Of the ones with no annotation, I think the following
are important:
 <ul>


<li>  DiscreteRandomSource.java
 <br>     Have Helper, has same issues and Ramp
Expression parser has problems if params are not of the same type.


<li>  Distributor.java
 <br>      No demo, have tests


<li>  ExpressionWriter
 <br>      Don't have a helper yet


<li>    IIR.java
<br>      IIR is important!
 <br>      Don't have a helper yet


<li>   Multiplexor.java
 <br>      Don't have a helper yet

</ul>

Next level of priority should be the array actors,
I think:

<pre>
     ArrayAppend.java
     ArrayAverage.java
     ArrayElement.java
     ArrayExtract.java
     ArrayLength.java
     ArrayMaximum.java
     ArrayMinimum.java
     ArraySort.java
     ArrayToElements.java
</pre>
None of these actors have helpers or tests


</body>
</html>

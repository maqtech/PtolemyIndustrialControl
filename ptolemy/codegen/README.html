<!-- $Id$ -->
<html>
<head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<title>Code Generation</title>
<link href="default.css" rel="stylesheet" type="text/css">
</head>
<body>
<html>
<h1>Code Generation</h1>
This code generator is patterened after the Ptolemy Classic 
code generator where actors have template files consisting
of code blocks.  The code blocks are stitched together to create
the resulting file.

<h2>Simple Ramp Demo</h2>
<ol>
<li>
Open <a href="demo/Ramp/Ramp.xml"><code>$PTII/ptolemy/codegen/Demo/Ramp/Ramp.xml</code></a>
<li> Click on the StaticSchedulingCodeGeneratorIcon.
<li> A dialog box will appear, click on "Generate"
<li> The code will be generated and displayed.
</ol>

<h2>How it works</h2>
This code generator uses reflection to find helper classes that in
turn refer to code blocks.  
<p>For example, if a model contains <code>ptolemy.actor.lib.Ramp</code>,
we look for in <code>$PTII/ptolemy/copernicus/codegen/c/actor/lib/</code>
for <code>Ramp.java</code> and <code>Ramp.c</code>.

<p><code>Ramp.java</code> contains a method:
<pre>
public void generateFireCode(StringBuffer stream)
                throws IllegalActionException {
        CodeStream tmpStream = new CodeStream(this);
        tmpStream.appendCodeBlock("codeBlock1");   

        stream.append(processCode(tmpStream.toString()));
    }
</pre>
The <code>codeBlock1</code> string above refers to the codeblock
in <code>Ramp.c</code>:
<pre>
/***codeBlock1*/
$ref(output) = $ref(init);
$ref(init) += $val(step);
/**/
</pre>

When the code generator runs, it runs <code>generateFireCode()</code>
which reads in <code>codeBlock1</code> and writes it to the output file.

The <code>$ref</code> and <code>$val</code> in <code>codeBlock1</code>
are macros, which represent ports, states (including parameters) of
the actor. For example, <code>$ref(output)</code> represents the
<code>output</code> port of the <code>Ramp</code> actor in this
model. When the code generator process a macro in the code string, it
replaces the macro with a unique variable or a concrete value
pertinent to the actor.

<p>
Currently, we have the following macros:
<p> <code>$ref(name)</code>

<br>Returns a reference of a state or a port. If the argument,
<code>name</code>, refers to a port, it by default refers to the first
token in the buffer of that port. If the port is a multiport, say
<code>input</code>, we use <code>$ref(input#0)</code> to refer to the
first channel of the <code>input</code> port.

<p> <code>$ref(name, offset)</code>

<br> Returns a reference to an array state or a port with an offset
that is not negative.  For a port, it refers to the
<code>offset</code>-th token in the buffer of that port. For an array
state, it refers to the <code>offset</code>-th element in the array.

<p><code>$val(name)</code>
<br>Returns the current value of a state.
<p><code>$size(name)</code>

<br>Returns the size of a state. The size of a non-array state is one;
the size of an array state is the length of the array.
<p>
<code>$actorSymbol(name)</code>
<br>
Returns a unique variable for the actor.
<p>

<h2>Invoking the code generator by hand</h2>
Use the command below to invoke the code generator by hand.
<pre>
$PTII/bin/ptinvoke ptolemy.codegen.kernel.CodeGenerator $PTII/ptolemy/codegen/c/actor/lib/test/auto/Ramp.xml
</pre>
Or, you can run <code>$PTII/bin/ptcg</code>, which invokes the CodeGenerator
class for you:
<pre>
$PTII/bin/ptcg $PTII/ptolemy/codegen/c/actor/lib/test/auto/Ramp.xml
</pre>

<h2>Helper writer style guide</h2>
<menu>
<li> Be sure to add and @see tag to the base actor

<li> When writing helpers, try to put as much as possible into
the .c file.  The reason is that if we have keep the language
specific code in the .c files, then in the future it will be easier
to support other languages.


<li> To add a comment to output from within a Java file, use
<CODE>CodeGenerator.comment()</CODE> so that the comment is
properly indented and has the appropriate language specific
comment tag.  For example,
<pre>
       code.append(_codeGenerator.comment("My Comment.");
</pre>
will append
<pre>
    /* My Comment. */
</pre>
to the output.
<br>Currently, only C-style comments are supported
<CODE>/* <I>comment</I> */</CODE>, but support for other 
languages will be easier if we avoid C specific code.

<li> Code should be properly indented.  Usually, actor
helper code written in .c files is indented 8 spaces so that
it is properly indented in the output file (four spaces
for the <CODE>main()</CODE> body, four spaces for the
<CODE>while()</CODE> or <CODE>for()</CODE> loop that
iterates through the actors.

</menu>


<h2>Status of individual classes</h2>


 <p>For each class, the number represent the number of demos that use that class.
     <br>The text underneath is the names of the demos that use that class.
     <br>And then the proposed and accepted ratings
     <br>And then comments  about the state of that class

<pre>

7 ptolemy.codegen.c.kernel.CParseTreeCodeGenerator
AdaptiveCoding
Butterfly
Hysteresis
Merge
ModalBSC
SynthesizedVoice
 @Pt.ProposedRating Red
 @Pt.AcceptedRating Red
 Has these limitations, will not be Yellow for release.
 * It is a copy of ParseTreeCodeGenerator from data/expr and thus
   has lots of code for evaluating expressions, which we don't need
 * It is not properly converting types: We need to add logic to
   convert types.
 * The .tcl test has known failures involving nulls
 * It does not evaluate constants.



7 ptolemy.codegen.c.kernel.CCodeGeneratorHelper
AdaptiveCoding
Butterfly
Hysteresis
Merge
ModalBSC
SynthesizedVoice
 @Pt.ProposedRating Red (mankit)
 @Pt.AcceptedRating Red (mankit)
 Need to look for c code in actor super classes.


7 ptolemy.codegen.c.actor.TypedCompositeActor
AdaptiveCoding
Butterfly
Hysteresis
Merge
ModalBSC
SynthesizedVoice
 @Pt.ProposedRating Yellow (cxh)
 @Pt.AcceptedRating Red (zgang)
 Ready for review

6 ptolemy.codegen.c.domains.sdf.kernel.SDFDirector
AdaptiveCoding
Butterfly
Hysteresis
Merge
ModalBSC
SynthesizedVoice
 @Pt.ProposedRating Yellow (cxh)
 @Pt.AcceptedRating Red (eal)
 Cleanup, then review (cxh)

5 ptolemy.codegen.c.domains.fsm.kernel.FSMActor
AdaptiveCoding
Hysteresis
Merge
ModalBSC
 @Pt.ProposedRating Red (zgang)
 @Pt.AcceptedRating Red (zgang)
 Gang: we reviewed this on March 7, can you update the tag?

4 ptolemy.codegen.c.domains.fsm.kernel.FSMDirector
AdaptiveCoding
Hysteresis
Merge
ModalBSC
 @Pt.ProposedRating Red (zgang)
 @Pt.AcceptedRating Red (zgang)
 Gang: we reviewed this on March 7, can you update the tag?

3 ptolemy.codegen.c.actor.lib.Ramp
AdaptiveCoding
Butterfly
Hysteresis
 @Pt.ProposedRating Red (cxh) String, Complex, Fix, Matrix and Array inputs are not supported
 @Pt.AcceptedRating Red (mankit) 
 Jackie: Add support for String and Array

3 ptolemy.codegen.c.actor.lib.MultiplyDivide
AdaptiveCoding
Butterfly
SynthesizedVoice
 @Pt.ProposedRating Red (mankit)
 @Pt.AcceptedRating Red (mankit)
 Complex, Fix, Matrix and Array inputs are not supported

3 ptolemy.codegen.c.actor.lib.Const
Butterfly
Hysteresis
ModalBSC
 * @Pt.ProposedRating Red (mankit)
 * @Pt.AcceptedRating Red (mankit)
 Need to test with Strings, Arrays before shipping
 What about Fix, Matrix

2 ptolemy.codegen.c.domains.hdf.kernel.HDFFSMDirector
AdaptiveCoding
Merge
 @Pt.ProposedRating Red (cxh)
 @Pt.AcceptedRating Red (zgang)
 Cleanup, then review

2 ptolemy.codegen.c.domains.hdf.kernel.HDFDirector
AdaptiveCoding
Merge
 @Pt.ProposedRating Red (cxh)
 @Pt.AcceptedRating Red (zgang)
 Cleanup, then review

2 ptolemy.codegen.c.domains.fsm.kernel.MultirateFSMDirector
AdaptiveCoding
Merge
 @Pt.ProposedRating Red (zgang)
 @Pt.AcceptedRating Red (zgang)
 Gang: we reviewed this on March 7, can you update the tag?

2 ptolemy.codegen.c.domains.fsm.kernel.FSMDirector
AdaptiveCoding
Hysteresis
Merge
ModalBSC
 @Pt.ProposedRating Red (zgang)
 @Pt.AcceptedRating Red (zgang)
 Gang: we reviewed this on March 7, can you update the tag?

2 ptolemy.codegen.c.actor.lib.gui.SequencePlotter
Hysteresis
ModalBSC
 @Pt.ProposedRating Red (zgang) Need to handle plot configuration info
 @Pt.AcceptedRating Red (zgang)
 Need to handle plot configuration info

2 ptolemy.codegen.c.actor.lib.conversions.BooleanToAnything
AdaptiveCoding
ModalBSC
 @Pt.ProposedRating Green (zgang)
 @Pt.AcceptedRating Green (zgang)
 Need tests for Array before shipping.

2 ptolemy.codegen.c.actor.lib.RandomSource
AdaptiveCoding
ModalBSC
 @Pt.ProposedRating Red (zgang)
 @Pt.AcceptedRating Red (zgang)
  
 Gang:  ProposedRating tag

2 ptolemy.codegen.c.actor.lib.Gaussian
Hysteresis
SynthesizedVoice
 * @Pt.ProposedRating Red (cxh) Extend RandomSource, move code to RandomSource
 * @Pt.AcceptedRating Red (mankit)
 Extend RandomSource, move code to RandomSource

2 ptolemy.codegen.c.actor.lib.AddSubtract
Butterfly
Hysteresis
 @Pt.ProposedRating Red (eal)
 @Pt.AcceptedRating Red (eal)
 Complex, Fix, Matrix and Array inputs are not supported

1 ptolemy.codegen.c.actor.lib.io.FileReader
SynthesizedVoice
 * @Pt.ProposedRating Red (mankit)
 * @Pt.AcceptedRating Red (mankit)
 This needs lots of work

1 ptolemy.codegen.c.actor.lib.gui.XYPlotter
Butterfly
 * @Pt.ProposedRating Red (mankit)
 * @Pt.AcceptedRating Red (mankit)
 Need to handle plot configuration info

1 ptolemy.codegen.c.actor.lib.gui.Display
Merge
 * @Pt.ProposedRating Red (mankit)
 * @Pt.AcceptedRating Red (mankit)
 Jackie, this handles Ints, Doubles, Strings and Tokens, is it ready
 for review? 

1 ptolemy.codegen.c.actor.lib.conversions.PolarToCartesian
Butterfly
 * @Pt.ProposedRating Yellow (mankit)
 * @Pt.AcceptedRating Red (mankit)
 Ready for review


1 ptolemy.codegen.c.actor.lib.UnaryMathFunction
Butterfly
 * @Pt.ProposedRating Yellow (mankit)
 * @Pt.AcceptedRating Red (mankit)
 Ready for review

1 ptolemy.codegen.c.actor.lib.Scale
ModalBSC
 @Pt.ProposedRating Red (cxh)
 @Pt.AcceptedRating Red (zgang)
  Complex, Fix, Matrix and Array inputs are not supported.

1 ptolemy.codegen.c.actor.lib.Pulse
Merge
 @Pt.ProposedRating Red (cxh)
 @Pt.AcceptedRating Red (zgang)
  Complex, Fix, Matrix and Array inputs might work, though it needs tests.


1 ptolemy.codegen.c.actor.lib.MonitorValue
AdaptiveCoding
 *  @Pt.ProposedRating Yellow (zgang)
 *  @Pt.AcceptedRating Red (zgang)
 Works with ints, doubles, strings
 Complex, Fix, Matrix and Array inputs are not supported
 Needs to work with Array to be shipped 

1 ptolemy.codegen.c.actor.lib.Minimum
Merge
 * @Pt.ProposedRating Yellow (cxh)
 * @Pt.AcceptedRating Red (mankit)
 Ready for review

1 ptolemy.codegen.c.actor.lib.Maximum
Merge
 * @Pt.ProposedRating Yellow (cxh)
 * @Pt.AcceptedRating Red (mankit)
 Ready for review

1 ptolemy.codegen.c.actor.lib.LookupTable
ModalBSC
 @Pt.ProposedRating Yellow (zgang)
 @Pt.AcceptedRating Red (zgang)
 Will this work with strings? 
 Before Yellow, need test for array and String

1 ptolemy.codegen.c.actor.lib.GradientAdaptiveLattice
SynthesizedVoice
 * @Pt.ProposedRating Yellow (cxh)
 * @Pt.AcceptedRating Red (mankit)

1 ptolemy.codegen.c.actor.lib.Accumulator
AdaptiveCoding
 * @Pt.ProposedRating Yellow (cxh)
 * @Pt.AcceptedRating Red (zgang)
 Ready for review, does this work on strings?

1 ptolemy.codegen.c.actor.lib.AbsoluteValue
SynthesizedVoice
 * @Pt.ProposedRating Yellow (cxh)
 * @Pt.AcceptedRating Red (mankit)
 Ready for review

</pre>

Edward wrote:
<BLOCKQUOTE>
the following should have highest priority, I think:
<ul>
<li> MathFunction
     <br>(deprecated, use UnaryMathFunction instead, which is used by Butterfly)


<li> FileReader.java
<pre>
    Not used in demo.
    The use of FileReader below is because we are using a
    static method in FileReader.
    The interpreted version of this actor needs work
</pre>



<li> Comparator.java
     <br>No demo, have tests


<li> Equals.java
     <br>No demo, have test


</ul>

Of the ones with no annotation, I think the following
are important:
 <ul>


<li>  DiscreteRandomSource.java
 <br>      Don't have a helper yet (jackie)


<li>  Distributor.java
 <br>      No demo, have tests


<li>  ExpressionWriter
 <br>      Don't have a helper yet


<li>  Exit.java
<br>       Don't have a helper yet


<li>    IIR.java
<br>      IIR is important!
 <br>      Don't have a helper yet


<li>   Multiplexor.java
 <br>      Don't have a helper yet

</ul>

Next level of priority should be the array actors,
I think:

<pre>
     ArrayAppend.java
     ArrayAverage.java
     ArrayElement.java
     ArrayExtract.java
     ArrayLength.java
     ArrayMaximum.java
     ArrayMinimum.java
     ArraySort.java
     ArrayToElements.java
</pre>
None of these actors have helpers or tests


</body>
</html>

<!-- $Id$ -->
<html>
<head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
<title>Code Generation</title>
<link href="default.css" rel="stylesheet" type="text/css">
</head>
<body>
<html>
<h1>Code Generation</h1>
This code generator is patterened after the Ptolemy Classic 
code generator where actors have template files consisting
of code blocks.  The code blocks are stitched together to create
the resulting file.

<h2>Simple Ramp Demo</h2>
<ol>
<li>
Open <a href="demo/Ramp/Ramp.xml"><code>$PTII/ptolemy/codegen/Demo/Ramp/Ramp.xml</code></a>
<li> Click on the StaticSchedulingCodeGeneratorIcon.
<li> A dialog box will appear, click on "Generate"
<li> The code will be generated and displayed.
</ol>

<h2>How it works</h2>
This code generator uses reflection to find helper classes that in
turn refer to code blocks.  
<p>For example, if a model contains <code>ptolemy.actor.lib.Ramp</code>,
we look for in <code>$PTII/ptolemy/copernicus/codegen/c/actor/lib/</code>
for <code>Ramp.java</code> and <code>Ramp.c</code>.

<p><code>Ramp.java</code> contains a method:
<pre>
public void generateFireCode(StringBuffer stream)
                throws IllegalActionException {
        CodeStream tmpStream = new CodeStream(this);
        tmpStream.appendCodeBlock("codeBlock1");   

        stream.append(processCode(tmpStream.toString()));
    }
</pre>
The <code>codeBlock1</code> string above refers to the codeblock
in <code>Ramp.c</code>:
<pre>
/***codeBlock1*/
$ref(output) = $ref(init);
$ref(init) += $val(step);
/**/
</pre>

When the code generator runs, it runs <code>generateFireCode()</code>
which reads in <code>codeBlock1</code> and writes it to the output file.

The <code>$ref</code> and <code>$val</code> in <code>codeBlock1</code> are macros, which represent
ports, states (including parameters) of the actor. For example, <code>$ref(output)</code> represents
the <code>output</code> port of the <code>Ramp</code> actor in this model. When the code generator
process a macro in the code string, it replaces the macro with a unique variable or a concrete value
pertinent to the actor.
<p>
Currently, we have the following macros:
<p>
<code>$ref(name)</code>
<br>
Returns a reference of a state or a port. If the argument, <code>name</code>, refers to a port, it
by default refers to the first token in the buffer of that port. If the port is a multiport, say
<code>input</code>, we use <code>$ref(input#0)</code> to refer to the first channel of the
<code>input</code> port.
<p>
<code>$ref(name, offset)</code>
<br>
Returns a reference to an array state or a port with an offset that is not negative.
For a port, it refers to the <code>offset</code>-th token in the buffer of that port. For an
array state, it refers to the <code>offset</code>-th element in the array.
<p>
<code>$val(name)</code>
<br>
Returns the current value of a state.
<p>
<code>$size(name)</code>
<br>
Returns the size of a state. The size of a non-array state is one; the size of an array state
is the length of the array.
<p>
<code>$actorSymbol(name)</code>
<br>
Returns a unique variable for the actor.
<p>
</body>
</html>

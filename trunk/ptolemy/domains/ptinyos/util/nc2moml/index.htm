<!-- $Id$ -->
<html>
  <head>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=iso-8859-1">
    <title>nc2moml</title>
  </head>
  <body>
    <h1>nc2moml</h1> 

    <p> <a href="http://www.tinyos.net#in_browser" target="_top">TinyOS</a> is an
    event-driven operating system designed for sensor network nodes
    that have very limited resources (e.g., 8K bytes of program
    memory, 512 bytes of RAM).  TinyOS, is used, for example, on the
    Berkeley MICA motes, which are small wireless sensor nodes.  <a
    href="httP://nescc.sourceforge.net#in_browser" target="_top">nesC</a> is an
    extension to the C programming language designed to embody the
    structuring concepts and execution model of TinyOS.

    <p>nc2moml is used to convert nesC files (.nc) into <a
    href="http://ptolemy.eecs.berkeley.edu/publications/papers/00/moml#in_browser" target="_top">MoML</a>
    (.moml) files.  This will create the Ptolemy II libraries of
    components that are used to assemble models.  TinyOS provides a
    rich library of nesC components. If you install TinyOS 1.x in
    <code>$PTII/vendors/ptinyos/tinyos-1.x</code> , then the Ptolemy
    II configure script will find it and automatically make the TinyOS
    libraries available.

    <h2>Installation instructions</h2>

 <p><BLOCKQUOTE>
	<B>Note: As of 10/05, Windows users will not be able
       to run TinyOS models inside Ptolemy.</B>
	The reason is that reloading the TinyOS shared objects
	into the running Ptolemy interface fails because the
	TinyOS shared objects use pthreads and under Windows, Java
	is using Windows native threads.  We are working on a
	solution.  In the interim, Windows users can convert 
	.nc files to .moml files and create models, but running
	the model fails.
</BLOCKQUOTE>

    <p> These installation instructions assume that you already have
    Ptolemy II installed, and that if you are running on Windows, you
    already have Cygwin installed.  These instructions also assume
    that you do not already have the nesC compiler nor TinyOS
    installed.  If you wish to use pre-existing installations, please
    set up the environment variables described in the steps below to
    point to proper directories.
	<BLOCKQUOTE>
	If you already have AVR tools, TinyOS and nesC installed, try:
	<pre>
cd $PTII
mkdir -p vendors/ptinyos
ln -s <I>location_of_your_tiny-1.x_tree</I> .
ln -s <I>location_of_your_nesc_tree</I> .
	</pre>
	Be sure to update to the latest nesC cvs version, then
	 proceed to 
	<a href="#environmentVariables">Set up the necessary
    environment variables</a> below.  You may skip installing TinyOS
	and nesc and proceed to running <CODE>nc2moml</CODE>.

	</BLOCKQUOTE>


    <h2><a name="nc2moml_source">How to install nc2moml by
    downloading/building nesC from CVS</a></h2>
    
    <p>The nesC compiler can be downloaded and compiled from source,
    which requires an impressive suite of tools.  These instructions
    ask you to first verify that you have the necessary programs
    installed, then to install the AVR tools, followed by TinyOS, then
    nesC.

    <ol>
      <li> Under Linux or Cygwin, you must have the following programs
      installed on your system:

        <ul> 
          <li> autoconf 2.50 or later 
          <li> bison 
          <li> emacs 
          <li> emacs-el 
          <li> gperf 
          <li> perl 
          <li> rpm 
        </ul>
        
        <p>For help with how to install these in Cygwin, see the
	<a href="http://ptolemy.eecs.berkeley.edu/ptolemyII/ptIIlatest/install.htm#cygwin">Ptolemy II Cygwin Instructions</a>.
	 Note that most installations will not have
        gperf on them, at least, so you will likely need to install at
        least that.</p>

      <li>You must install the following AVR tools:
        <ul>
          <li> avarice
          <li> avr-binutils
          <li> avr-gcc
          <li> avr-insight
          <li> avr-libc
        </ul>
        <p>

          Note: If the files below do not work for you, you can try
          using the latest files (although these have not been tested
          with Viptos yet): <a
          href="http://www.tinyos.net/dist-1.2.0/tools"
          target="_top"><code>
          http://www.tinyos.net/dist-1.2.0/tools</code></a>.


        <p>
        Choose and follow the appropriate directions for your operating system:
        <ul>
          <li> If you are running Windows XP or Windows 2000, you can either:
            <ul>
              <li> Download WinAVR
   	       <ol> 
                  <li>Go to 
                    <a href="http://sourceforge.net/project/showfiles.php?group_id=68108#in_browser" target="_top"><code>http://sourceforge.net/project/showfiles.php?group_id=68108</code></a>              
                  <li>Download
<a href="http://prdownloads.sourceforge.net/winavr/WinAVR-20040404-bin-install.exe?download" target="_top"><code>WinAVR-20040404-bin-install.exe</code></a>
                  <br><b>Note:</b> Do <b>not</b> install 
		  <code>WinAVR-20050214-install.exe</code>, as of 10/05,
		  it will not work.  When converting .nc files to .moml files,
		  you will see messages about avr-gcc not being able to find
		  cc1.  Instead, install
		  <code>WinAVR-20040404-bin-install.exe</code>.
                  <li>Install Winavr in any directory, <code>C:\WinAVR</code>
		  is preferred.
                    <i>FIXME: Directories with spaces in the pathname might not work?</i>
                  <li>Under Windows with WinAVR-20040404, we had to copy 
		  <code>c:/cygwin/usr/local/lib/ncc/</code> to
		  <code>c:/usr/local/lib/ncc/</code>:
		  <pre>
		  mkdir -p c:/usr/local/lib
		  cd c:/usr/local/lib
		  cp -r /usr/local/lib/ncc .
		  </pre>
		  The reason is that Cygwin mounts directories under
		  </code>c:/cygwin</code> and the WinAVR binaries don't
		  know how to handle that.
                </ol>
            </ul>
            Or
            <ul>

              <li> Download the <a
              href="http://webs.cs.berkeley.edu/tos/dist-1.1.0/tinyos/windows/tinyos-1.1.0-1is.exe">TinyOS
              Installshield Wizard</a>.  Run the wizard, and choose
              "Custom" install.  Install only the AVR tools.  This
              will install all of the rpms below for you. <b>Do not
              choose the "cygwin" install option (it will overwrite
              and corrupt your current cygwin installation) or the
              "TinyOS" install option (you will install this later
              from CVS as a separate step).</b> You may choose to
              install the other remaining options if you do not
              already have them installed on your system.  The wizard
              will install all of the selected rpms for you.  JavaCOMM
              is not needed if you are not planning on using the
              TinyOS java tools (these are not needed for Viptos).
            </ul>
            Or
            <ul>
              <li> <b>If your Cygwin is installed so your 'Default
              Text File Type' is Unix</b>, download the following rpms
              to an empty directory:

	      <br><b>Note</b>: If your Cygwin installation has
	      'Default Text File Type' of Unix instead of DOS, then
	      you will likely have 
	      <a href="http://www.gigascale.org/softdevel/faq/23.html#in_browser"
	      target="_top">Cygwin CR/NL problems</a> with CVS.
	
             <p><B>Installing the rpms under Cygwin is not recommended</B>,
		it causes include file problems later.
	      <li> FIXME the list below is old, we should try:
	      <a href="http://www.tinyos.net/dist-1.2.0/tools/"><code>http://www.tinyos.net/dist-1.2.0/tools/</code></a>

             <ul>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avarice-2.0.20030825cvs-1w.cygwin.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avarice-2.0.20030825cvs-1w.cygwin.i386.rpm</a>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avr-binutils-2.13.2.1-1w.cygwin.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avr-binutils-2.13.2.1-1w.cygwin.i386.rpm</a>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avr-gcc-3.3tinyos-1w.cygwin.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avr-gcc-3.3tinyos-1w.cygwin.i386.rpm</a>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avr-insight-pre6.0cvs.tinyos-1w.cygwin.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avr-insight-pre6.0cvs.tinyos-1w.cygwin.i386.rpm</a>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avr-libc-20030512cvs-1w.cygwin.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/avr-libc-20030512cvs-1w.cygwin.i386.rpm</a>
                </ul>
                and install them on the cygwin command line by typing:
                
                <pre>rpm --ignoreos -ivh *.rpm</pre> 

                in the directory where you saved the files.
		
		 <p>If you get a message about checksum errors, complain
		to the TinyOS authors and then reinstall Cygwin with 
		<CODE>Unix</CODE> line endings.
 <p><I>Note to tinyos developers:  Unix line endings are not the right choice for naive Windows users.  </I>

		 <p>If you get
		<pre>
		bash-3.00$ rpm --ignoreos -ivh *.rpm
		error: Failed dependencies:
		/bin/sh is needed by make-3.80tinyos-1
		/bin/sh is needed by mspgcc-win32tinyos-20041204-2
	        bash-3.00$
		</pre>
		Then try 
		<pre>
		rpm --ignoreos --nodeps -ivh *.rpm
		</pre>

</I>
</BLOCKQUOTE>


                <p>
                  The rpms are also available
                  <a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/windows/#in_browser" target="_top">here</a>.  
            </ul>

          <li> If you are running Linux (Redhat 9), download the rpms from
          <a
          href="http://webs.cs.berkeley.edu/tos/dist-1.1.0/tools/linux#in_browser" target="_top">here</a>.  More convenient links are included here:
            <ul>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avarice-2.0.20030825cvs-1.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avarice-2.0.20030825cvs-1.i386.rpm</a>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avr-binutils-2.13.2.1-1.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avr-binutils-2.13.2.1-1.i386.rpm</a>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avr-gcc-3.3tinyos-1.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avr-gcc-3.3tinyos-1.i386.rpm</a>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avr-insight-pre6.0cvs.tinyos-1.3.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avr-insight-pre6.0cvs.tinyos-1.3.i386.rpm</a>
<li><a href="http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avr-libc-20030512cvs-1.i386.rpm">http://today.cs.berkeley.edu/tos/dist-1.1.0/tools/linux/avr-libc-20030512cvs-1.i386.rpm</a>
            </ul>
            and install them on the cygwin command line with 
            <pre>rpm -ivh *.rpm</pre> 
            in the directory where you saved the files.
        </ul>

        (The directions above were modified from the
	 <a href="http://webs.cs.berkeley.edu/tos/download.html#in_browser" target="_top">original TinyOS installation directions</a>).

      <li>Make a directory into which to store the source code, for
      example:
        <pre>
    mkdir -p $PTII/vendors/ptinyos
        </pre>
	Note that <CODE>$PTII</CODE> should not have spaces in it.

      <li> We have put into the TinyOS makefiles a rule that you can
      run to create all the TinyOS libraries in one step. To use this,
      as of this writing, you need to get TinyOS from the CVS
      repository rather than getting the packaged install version. To
      do this, type:</p>

        <pre>
cd $PTII/vendors/ptinyos
cvs -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/tinyos login
<i>Hit Enter when prompted for a password</i>
cvs -z3 -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/tinyos co tinyos-1.x
        </pre>
 <p><I>Note to tinyos developers: why is this download so large?  Perhaps there should be a core cvs module and then a contrib module?</I>

        This will create a directory <code>tinyos-1.x</code>.  For more
        information, see <a
        href="http://sourceforge.net/cvs/?group_id=28656#in_browser"><code>http://sourceforge.net/cvs/?group_id=28656</code></a>.

      <li> <a name="environmentVariables">Set up the necessary environment variables.</a>
  TOSROOT sets the location of the TinyOS source tree.  TOSDIR sets the subdirectory in the TinyOS source tree.  PTINYOS_MOMLROOT sets the MoML output directory.
        <ul>
          <li>Under bash, type: 
            <pre>
export TOSROOT=$PTII/vendors/ptinyos/tinyos-1.x
export TOSDIR=$TOSROOT/tos
export PTINYOS_MOMLROOT=$PTII/vendors/ptinyos/moml
            </pre>

          <li>Under csh or tcsh:
            <pre>
setenv TOSROOT $PTII/vendors/ptinyos/tinyos-1.x
setenv TOSDIR $TOSROOT/tos
setenv PTINYOS_MOMLROOT $PTII/vendors/ptinyos/moml
            </pre>

          <li>Under Windows with Cygwin, you can permanently set
          environment variables from the System control panel. (For
          details, see <a href="http://ptolemy.eecs.berkeley.edu/ptolemyII/ptII4.0/ptII/doc/install.htm#settingptII">Set the value of
          the PTII environment variable</a>).

            <p>
            Go to Start Menu -> Settings -> Control Panels -> System -> Advanced -> Environment Variables.
              <br>
              Set <code>TOSROOT</code> to <code>%PTII%/vendors/ptinyos/tinyos-1.x</code>
              <br>
              Set <code>TOSDIR</code> to <code>%PTII%/vendors/ptinyos/tinyos-1.x/tos</code>
              <br>
              Set <code>PTINYOS_MOMLROOT</code> to <code>%PTII%/vendors/ptinyos/moml</code>
        </ul>

      <li> Get the nesC CVS Tree, see <a
      href="http://sourceforge.net/cvs/?group_id=56288#in_browser" target="_top"><CODE>http://sourceforge.net/cvs/?group_id=56288</CODE></a>

        <pre>
cd $PTII/vendors/ptinyos
cvs -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/nescc login
<i>Hit Enter when prompted for a password</i>
cvs -z3 -d:pserver:anonymous@cvs.sourceforge.net:/cvsroot/nescc co nesc
        </pre>

      <li> Boostrap nesC 
        <pre>
cd $PTII/vendors/ptinyos/nesc
./Bootstrap
        </pre>

      <li> Run configure for nesc 
        <pre>
./configure
        </pre>
        By default, this configuration will cause nesC to be installed
        in <code>/usr/local</code>.  We assume that
        <code>/usr/local/bin</code> is in your path.  If you wish to
        install in a different directory, run <code>./configure
        --prefix=&lt;MYDIR&gt;</code> instead and add the
        <code>bin</code> directory to your path.

        <p> FIXME: Necessary? If you are using Cygwin, and configure
        has trouble finding <code>TOSROOT</code> or
        <code>TOSDIR</code>, try expanding your <code>$PTII</code>
        environment variable to <code>/cygdrive/c/ptII</code> or
        something similar.  Also try expanding the
        <code>TOSROOT</code> and <code>TOSDIR</code> environment
        variables if you still have problems.

      <li> Install nesc 
        <pre>
make
make install
        </pre>

        <p>FIXME: necessary? If you are using Cygwin and make cannot
        find avr-gcc, then avr-gcc is probably not in your path.
        Locate avr-gcc and add the directory to your path.  If you
        cannot find avr-gcc, then the AVR rpm's were not installed
        correctly, and you will need to try to reinstall them.

      <li> Configure and install the TinyOS nesC tools
        <pre>
cd $TOSROOT/tools/src/ncc
./Bootstrap
./configure
        </pre>
        By default, this configuration will cause the tools to be
        installed in <code>/usr/local</code>.  We assume that
        <code>/usr/local/bin</code> is in your path.  If you wish to
        install in a different directory, run <code>./configure
        --prefix=&lt;MYDIR&gt;</code> instead and add the
        <code>bin</code> directory to your path.

	<pre>
make
make install

	</pre>
	make failed for me:
<pre>
Making all in libcompat
make[3]: Entering directory `/cygdrive/c/cxh/ptII/vendors/ptinyos/nesc/src/libcompat'
if gcc -DHAVE_CONFIG_H -I. -I. -I.. -DNMEMDEBUG -DNDEBUG -O9    -g -Wall -MT regions.o -MD -MP -MF ".deps/regions.Tpo" -c -o regions.o regions.c; \
then mv -f ".deps/regions.Tpo" ".deps/regions.Po"; else rm -f ".deps/regions.Tpo"; exit 1; fi
In file included from /usr/local/include/sys/types.h:331,
                 from /usr/local/include/sys/unistd.h:9,
                 from /usr/local/include/unistd.h:4,
                 from stats.c:3,
                 from regions.c:40:
/usr/include/cygwin/types.h:152: error: conflicting types for 'key_t'
/usr/local/include/sys/types.h:137: error: previous declaration of 'key_t' was here
/usr/include/cygwin/types.h:179: error: parse error before "u_int16_t"
/usr/include/cygwin/types.h:187: error: parse error before "u_int64_t"
/usr/include/cygwin/types.h:202: error: conflicting types for 'mode_t'
/usr/local/include/sys/types.h:142: error: previous declaration of 'mode_t' was here
In file included from /usr/local/include/fcntl.h:1,
                 from stats.c:4,
                 from regions.c:40:
/usr/local/include/sys/fcntl.h:139: error: redefinition of `struct flock'
make[3]: *** [regions.o] Error 1
</pre>
	The solution was to uninstall one of the rpms.
<pre>
cd <I>Location of avr rpms</I>
rpm -e arm-thumb-elf-gcc-3.2-1
cd $PTII/vendors/ptinyos/nesc
make
make install
cd <I>Location of avr rpms</I>
rpm -force --ignoreos --nodeps -ivh *.rpm
</pre>

 <p><I>Note that you need to have <CODE>pdflatex</CODE> and <CODE>bibtex</CODE> installed, or else edit <CODE>nesc/Makefile</CODE> and comment remove
<CODE>doc</CODE> from the <CODE>SUBDIRS</CODE> line.
</I>


      <li> Compile tinyos
      <pre>
cd $PTII/vendors/ptinyos/tinyos-1.x
make
make install
      </pre>
      <p><CODE>tinyos-1.x/tools/src/uisp/src/Serial.C</CODE>  failed to compile
      <pre>
Serial.C: In member function `void TSerial::OpenPort()':
Serial.C:243: warning: right-hand operand of comma has no effect
Serial.C:244: warning: right-hand operand of comma has no effect
make[4]: *** [Serial.o] Error 1
      </pre>

      The solution is to edit
      <CODE>tinyos-1.x/tools/src/uisp/src/Makefile</CODE>
      and remove the <CODE>-Werror</CODE> and rerun make from the top.

      <li> Run the script that will unzip the file that contains
      additional compiler flags.  It will place "opts" files into
      various directories in your tinyos-1.x tree.  The script assumes
      that you have placed your tinyos-1.x tree as indicated in the
      instructions above.
        <pre>
cd $PTII/ptolemy/domains/ptinyos/util
./unzip-opts.sh
        </pre>

      <li> Run the script to generate the .moml files from the .nc files.
        <pre>
cd $PTII/ptolemy/domains/ptinyos/util/nc2moml
./nc2moml
        </pre>
	The <CODE>nc2moml</CODE> command will take 10-30 minutes to complete.

        <p> Note: The nc2moml tool requires that you build the tools in <CODE>$PTII/bin</CODE>.  Do the following and rerun the script above if they are missing:
        <pre>
cd $PTII/bin
make
        </pre>
      <li> See if it worked:
        <ol> 
          <li> You should see some valid MoML code in:
            <pre>$PTII/vendors/ptinyos/moml</pre>
            <br>
            The directory structure should reflect that of the TinyOS
            directory structure.

          <li> 
            <ol>
              <li>Try running Viptos:
                <pre>vergil -ptinyos</pre>

              <li>Create a new PtinyOS Graph Editor from the File |
              New menu.

              <li>Click in the left hand pane under Actors to see the
              newly generated directory structure.
            </ol>
        </ol>
    </ol>


</body>
</html>

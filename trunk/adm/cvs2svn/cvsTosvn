#!/bin/sh
# Convert a repo from cvs to svn

if [ $# -ne 2 ]; then
  echo "$0: Usage: $0 repohome rep"
  echo "For example $0 cvs_terraswarm esweek13"
  exit 4
fi

cvsrepohome=$1
cvsrepo=$2

if [ ! -f "$PTII/adm/cvs2svn/cvsTosvn"]; then
    echo "$0: Could not find $PTII/adm/cvs2svn/cvsTosvn"
    echo "Perhaps $PTII is not set?"
    exit 5
fi

if [ ! -f $PTII/adm/cvs2svn/cvs2svn-2.4.0/cvs2svn ]; then
    echo "Downloading cvs2svn-2.4.0.  Check http://cvs2svn.tigris.org/ to see if this is the most recent version."
    (cd $PTII/adm/cvs2svn; http://cvs2svn.tigris.org/files/documents/1462/49237/cvs2svn-2.4.0.tar.gz; tar -xf - cvs2svn-2.4.0.tar.gz)
fi

if [ ! -d tmp.cvs/$cvsrepo ]; then
  echo "Checking out the $cvsrepo cvs repository."
  if [ ! -d tmp.cvs ]; then
    mkdir tmp.cvs
  fi    
  cd tmp.cvs
  cvs -d :ext:source.eecs.berkeley.edu:/home/$cvsrepohome co $cvsrepo
  cd $cvsrepo
  echo "Checking for -kb problems."
  $PTII/adm/cvs2svn/fixcvs
  status=$?
  cd ../..
  if [ $status -ne 0 ]; then
     echo "fixcvs found some problems with files not being checked in.  Quitting."
     exit $status
  fi
fi


if [ ! -d $cvsrepohome/$cvsrepo ]; then
  echo "Creating $cvsrepohome/$cvsrepo from source.eecs."
  ssh source "cd /home; gtar zcf - --exclude=commitlogs $cvsrepohome/CVSROOT $cvsrepohome/$cvsrepo" > $cvsrepo.tar.gz
  tar -zxf $cvsrepo.tar.gz
fi

if [ ! -d repos ]; then
  mkdir repos
fi


if [ ! -f $PTII/adm/cvs2svn/cvs2svn-2.4.0/cvs2svn ]; then
    echo "$0: could not find $PTII/adm/cvs2svn/cvs2svn-2.4.0/cvs2svn?  see http://cvs2svn.tigris.org/"
    exit 6
fi

echo "Converting the cvs repository."
$PTII/adm/cvs2svn/cvs2svn-2.4.0/cvs2svn --default-eol=native --auto-props=/home/cxh/.subversion/config --fallback-encoding=utf8 -s repos/$cvsrepo $cvsrepohome

echo "Checking out the $cvsrepo svn repository."
svnrepo=file:///`pwd`/repos/$cvsrepo
rm -rf tmp.svn
mkdir tmp.svn
cd tmp.svn
svn co $svnrepo
cd $cvsrepo
pwd
svn mv trunk/$cvsrepo/* .
svn commit -m "After conversion from cvs to svn, moved trunk/$cvsrepo to the toplevel."
cd ../..

diff -I '\$Id:' -r tmp.cvs/$cvsrepo tmp.svn/$cvsrepo | egrep -v 'Only in.*CVS$'




#!/bin/sh
# Find missing demos
# $Id$
# 1) Get all the demos from ptolemy/configs/doc/models.txt
# 2) For each demo/ directory in models.txt, look for .xml files that are not listed
#

verbose=no
if [ "$1" = "-v" ]; then
    verbose=yes
else
    echo "# $0: Use $0 -v to generate html suitable for completeDemos.htm"
fi

modelsFile=$PTII/ptolemy/configs/doc/models.txt
demos1=/tmp/missingDemos.demos1.$$
cat $modelsFile | grep /demo/ | awk -F / '{for (i=2;i<=NF;i++) {printf("%s/", $i); if ($i ~ /demo/) {printf("\n"); break}}}' | sed 's@demo/$@demo@' | sort | uniq > $demos1
   

# Look for demo directories that are not listed in completeDemos
demos2=/tmp/missingDemos.demos2.$$
(cd $PTII; find . -name demo -type d | egrep -v '(adm|signed|vendors)' | sed 's@^\./@@' | sed 's@demo/$@demo@' | sort ) | egrep -v '(com/microstar/xml/demo|diva/canvas/demo|doc/codeDoc/diva/canvas/demo|doc/doccheck/diva/canvas/demo|org/terraswarm/gdp/src/gdp.*/demo|ptolemy/apps)' > $demos2

echo "# Demo directories that are not listed in $PTII/ptolemy/configs/doc/completeDemos.htm"
comm -3 $demos1 $demos2

# Script that prints out html for the demos.
# $demos is the list of .xml files for which we are to print demos.
function demoHTML {
    if [ $1 = "yes" ]; then 
        if [ ! -z "$2" ]; then
            foundDemo=no
            for demo in $2
            do                 
                demoDirectory=`dirname $demo`
                demoName=`basename $demoDirectory`
                if [ $demo = "$demoDirectory/$demoName.xml" ]; then
                   echo "      <li><a href=\"../../../$demo\">$demoName</a>(New in Ptolemy II 11.0)</li>"
                   foundDemo=yes
                fi
            done
            if [ $foundDemo = "no" ]; then
                echo "      <!-- Did not find demo with the same name as the directory? -->"
            fi
        fi
    fi
}

if [ $verbose = "yes" ]; then 
    demoDirectories=`comm -3 $demos1 $demos2 | awk '{print $1}'`
    for demoDirectory in $demoDirectories
    do
        echo $demoDirectory                     
        dirname=`dirname $demoDirectory`
        package=`basename $dirname`
        demos=`ls $demoDirectory/*/*.xml`

        if [ -z "$demos" ]; then
            echo "$demoDirectory contains no subdirectories with models."
            continue;
        fi

        # For each demo in the directory, check to see if
        # it appears in completeDemos.htm as a commented out demo
        # If there is any demo that does not appear in
        # completeDemos as a commented out demo, then print
        # html for those demos

        missingDemos=""
        for demo in $demos
        do
            egrep "<!--.*$demo" $PTII/ptolemy/configs/doc/completeDemos.htm  >& /dev/null
            status=$?
            if [ $status -eq 1 ]; then
                missingDemos="$missingDemos $demo"
            fi
        done

        if [ ! -z "$demos" -a -z "$missingDemos" ]; then
            echo "$demoDirectory contains demos that are in completeDemos.htm, but commented out."
        else
            echo "demos: $demos, missingDemos: $missingDemos"

            cat <<EOF

    <li><a href="#$package"></a></li>
...
    <h2><a name="$package"></a></h2>
    <ul><!-- Alphabetical Please -->
EOF

            demoHTML $verbose "$missingDemos"
            echo "    </ul>"
        fi
    done    
fi

echo "# Look for .xml files that are in directories listed in completeDemos,"
echo "#  but not the .xml file itself is not listed."
modelsInModelsFile=/tmp/missingDemos.modelsInModelsFile.$$
modelsInDemoDirectory=/tmp/missingDemos.modelsInDemoDirectory.$$
for demoDirectory in `cat $demos1`
do
    # echo "# Checking $demoDirectory"
    
    individualDemoDirectories=`find $demoDirectory -type d -depth 1`
    for individualDemoDirectory in $individualDemoDirectories
    do                                   
        demoName=`basename $individualDemoDirectory`
        demoModel=`echo "$individualDemoDirectory/$demoName.xml" | sed "s@$PTII@@"`
        if [ ! -f "$PTII/$demoModel" ]; then
            echo "$demoModel is not present"
            demoHTML $verbose $demoModel
        fi

        grep $demoModel $modelsFile >& /dev/null
        status=$?
        if [ $status -eq 1 ]; then
            echo "$demoModel is not present in completeDemos.xml"
            demoHTML $verbose $demoModel
        fi           
    done
    # find $PTII/$demoDirectory -name "*.xml" | sed "s@$PTII/@@" > $modelsInDemoDirectory
    # grep $demoDirectory $modelsFile | sed 's@\$CLASSPATH/@@' > $modelsInModelsFile

    # comm -23 $modelsInDemoDirectory $modelsInModelsFile

    # if [ $verbose = "yes" ]; then 
    #     demos=`comm -23 $modelsInDemoDirectory $modelsInModelsFile | awk '{print $1}'`
    #     demoHTML
    # fi
done

rm -f /tmp/missingDemos.*

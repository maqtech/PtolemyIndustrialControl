#!/bin/sh
# %W% %G%
# Script to mail a message about nightly build
# ptIInightly run make nightly which runs this script when everything is done
# This convoluted system is necessary so we can build on multiple
# machines simulatneously

#mailto=ealtech
#mailto=cxh
#if [ $# -ne 1 ]; then
#    echo "$0: Usage: $0 email-address"
#    exit 4
#fi
mailto=$1

ADMDIR=/home/bldmastr/ptII/adm
GENDIR=$ADMDIR/gen-1.0
cd $GENDIR


# Generate the mail message
mailmsg=$ADMDIR/logs/ptIInightly.mail

echo "`date`" > $mailmsg
echo "The Ptolemy II nightly build is run from a bldmaster cronjob" >> $mailmsg
echo "See http://www.gigascale.org/buildmaster" >> $mailmsg

# The log of the build
#ptbuildlog=/users/ptII/logs/java`date  '+%m%d'`
ptbuildlog=/home/bldmastr/ptII/adm/logs/ptIInightly.txt
#(cd /users/ptII/logs; rm -f javalastnight; ln -s java`date  '+%m%d'` javalastnight)

# Remove logs older than 45 days
#find /users/ptII/logs -name "java[0-9]*" -mtime +45 -exec rm {} \;


#echo "The size of the Ptolemy II tar file:" >> $mailmsg
#ls -l $GENDIR/.gz >> $mailmsg
#echo "" >> $mailmsg
#echo "To download the latest build, or see a list of changed files, go to"  >> $mailmsg
#echo "http://ptolemy.eecs.berkeley.edu/~ptII/ptIItree/adm/gen-1.0"  >> $mailmsg
#echo "" >> $mailmsg
#echo "The links below are on the nightly build page:" >> $mailmsg
#echo "http://ptolemy.eecs.berkeley.edu/~ptII/nightly" >> $mailmsg

#echo "" >> $mailmsg
echo "------------------------------------------------" >> $mailmsg
echo "Errors during the build and test process in ptII:" >> $mailmsg
echo "" >> $mailmsg
echo "To see the complete build and test log, see:" >> $mailmsg
echo "http://www.gigascale.org/ptolemy/src/ptII/adm/logs/ptIInightly.txt" >> $mailmsg
echo "" >> $mailmsg

# print out 'Entering directory' lines
awk ' $0 ~ /Entering directory/ { indir=$0 }
      $0 ~ /\*\*\*/ { 	print indir
			print $0
		      }' $ptbuildlog >> $mailmsg

echo "javadoc had the following `grep 'javadoc: warning' $ptbuildlog | wc -l` warnings" >> $mailmsg

awk ' $0 ~ /^Generating/ { indir=$0 }
      { if ($0 ~ /javadoc: warning/) {
	    print indir
	    print $0
	    sawjavadocwarning=1
        } else {
	    if (sawjavadocwarning == 1) {
		sawjavadocwarning=0
		if ( $0 ~ /^	/) {
		    print $0
		}
   	        print ""
	    }
	}
      }' $ptbuildlog >> $mailmsg


echo "" >> $mailmsg

echo "The build had the following `egrep 'deprecated\.' $ptbuildlog| egrep 'in (class|interface) ptolemy.' | wc -l ` warnings for using deprecated ptolemy methods" >> $mailmsg
echo "The warnings are broken down as:" >> $mailmsg
egrep 'deprecated\.' $ptbuildlog | egrep 'in (class|interface) ptolemy.' | awk '{print $6'} | sort | uniq -c | sort -nr >> $mailmsg

echo "" >> $mailmsg
echo "The warnings themselves are:" >> $mailmsg
egrep 'deprecated\.' $ptbuildlog | egrep 'in (class|interface) ptolemy.' >> $mailmsg

#egrep '\*\*\*' $ptbuildlog >> $mailmsg

#echo "" >> $mailmsg
#echo "------------------------------------------------" >> $mailmsg
#echo "Errors during the tar file build, code coverage statistics " >> $mailmsg
#echo "process, jdk1.1 build, cvs checkout build:" >> $mailmsg
#echo "" >> $mailmsg
#echo "To see the complete tar file build and coverage log, view:" >> $mailmsg
#echo "/users/ptII/adm/test/ptIInightly.txt" >> $mailmsg
#echo "or" >> $mailmsg
#echo "http://ptolemy.eecs.berkeley.edu/~ptII/ptIItree/adm/test/ptIInightly.txt" >> $mailmsg
#echo "" >> $mailmsg

#egrep '\*\*\*' $ADMDIR/test/ptIInightly.txt >> $mailmsg

#echo "" >> $mailmsg
#echo "------------------------------------------------" >> $mailmsg
#echo "Diffs between tonight's build and lastnight's build" >> $mailmsg
# cat $ADMDIR/test/ptIInightly.diffs >> $mailmsg

echo "" >> $mailmsg
echo "------------------------------------------------" >> $mailmsg
echo "Test results during code coverage" >> $mailmsg
echo "" >> $mailmsg
echo "............................................................" >> $mailmsg
echo "|To add a directory to the list of directories to be tested|" >> $mailmsg
echo "|edit the value of JSALLDIRS in $GENDIR/makefile|" >> $mailmsg
echo "............................................................" >> $mailmsg
echo "" >> $mailmsg
# Note that we only grep for the tests run during code coverage
# which only occurred on /export/tycho/tycho2
egrep 'Total Tests' $ptbuildlog >> $mailmsg

echo "" >> $mailmsg
echo "------------------------------------------------" >> $mailmsg
echo "Code Coverage Summary" >> $mailmsg
echo "" >> $mailmsg
echo "To see code coverage, view:" >> $mailmsg
echo "http://www.gigascale.org/ptolemy/nightly/coverage.html" >> $mailmsg
echo "" >> $mailmsg
sh $ADMDIR/bin/coveragesummary >> $mailmsg

echo "" >> $mailmsg
echo "------------------------------------------------" >> $mailmsg
echo "Test Failures during code coverage." >> $mailmsg
echo "" >> $mailmsg
egrep 'Total Tests' $ptbuildlog |
    egrep -v '^Failed: 0' >> $mailmsg


cat $mailmsg | /usr/ucb/Mail -s "Ptolemy II Nightly Build" $mailto
